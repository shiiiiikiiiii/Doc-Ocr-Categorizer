## 简介

### 目标与背景

本项目的主要目标是设计一个智能文档自动识别与分类系统，利用OCR技术识别文档，结合NLP模型和推荐算法, 实现对文档的智能化处理。

```text
面对现代科技与信息化的不断提高，大学生在大学阶段产生的文档材料不断增多，例如成绩单、社团申请书、学生档案等。传统的手动整理文档工作效率低下，需要人员持续监督，增加了人力成本。因此，通过结合OCR技术和NLP深度学习算法，我们可以将这些文档自动化地分类、识别和管理，提高工作效率。
```

### 项目特色

- **智能分类：** 利用OCR技术将扫描版文档转换为文本，并通过推荐算法和NLP方法实现文档的自动分类。

- **推荐系统：** 基于用户上传文档的历史记录，引入推荐算法为文档自动分类提供参考，提高分类准确性。

- **用户友好界面：** 设计一个直观、易用的用户界面，使用户能够方便地上传和处理文档，并查看识别和分类的结果。

- **多层次管理**
  
  1. **文档库**层次: 文档库是最高一个层次,用于组织和管理多个文档分类。每个文档库下可以包含多个文档分类。例如可以建立学生文档库、医院文档库，这样每个库可以分别设置权限。
  2. **文档分类**层次: 文档分类属于特定的一个文档库,一个文档分类下可以包含多个文档。例如学生文档库下分类可能包括社团申请书分类、成绩单分类、学籍分类。
  3. **文档**层次: 文档属于一个特定的文档分类,是最基础的管理单位。任何单个文档都属于此层次。

### 技术选择

- **前端:** React, Antd
- **后端:** FastAPI
- **关系数据库:** PostgreSQL
- **存储服务:** MinIO
- **OCR算法:** RapidOCR
- **NLP算法:** multilingual-e5-large-instruct
- **推荐算法:** pgvector

## OCR与NLP具体模型选择和调试计划

1. _由于PaddleOCR部署和调用不是很方便,_ 选用了基于PaddleOCR, 但是更方便部署的**RapidOCR**
2. 使用**intfloat/multilingual-e5-large-instruct**模型, 使用**sentence-embedding**方法, 将OCR结果提取为向量

### 推荐算法进行文档分类推荐

- 使用PgSQL插件**pgvector**, 实现基于向量相似度的推荐

## API列表

### 用户相关API

### 用户相关API

1. **用户注册：**
   - `POST /users/register`
     - 输入参数：
       - `username`：用户账号名称
       - `password`：加密后的用户密码
       - `email`：用户邮箱地址
     - 返回值：成功时返回新创建用户的唯一标识（如user_id）以及其他相关信息，失败时返回错误信息。

2. **用户登录：**
   - `POST /users/login`
     - 输入参数：
       - `username`：用户账号名称
       - `password`：用户密码（通常经过客户端加密传输）
     - 返回值：成功时返回JWT（Json Web Token）用于后续请求的身份验证，以及用户基本信息，失败时返回错误信息。

6. **用户注销登录：**
   - `POST /users/logout`
     - 需要认证：此接口需携带JWT token进行访问
     - 返回值：成功注销登录，返回确认信息。

3. **获取当前登录用户信息：**
   - `GET /users/me`
     - 需要认证：此接口需携带JWT token进行访问
     - 返回值：返回当前登录用户的详细信息，包括但不限于用户名、邮箱、角色、权限等。

4. **用户信息更新：**
   - `PATCH /users/{userId}`
     - 输入参数：
       - `userId`：用户ID
       - `patch_data`：包含需要更新的用户属性（如姓名、邮箱、联系方式等）的对象
     - 需要认证：只有当用户本人或管理员才能更新信息
     - 返回值：成功时返回更新后的用户信息，失败时返回错误信息。

5. **用户密码重置：**
   - `PATCH /users/reset_password`
     - 输入参数：
       - `username`：用户账号名称
       - `reset_token`：从邮件发送的重置链接中获取的令牌
       - `new_password`：用户的新密码
     - 返回值：成功时返回确认信息，失败时返回错误信息。

### 文档相关API

1. **上传文档：**
   
   - `POST /upload` - 上传扫描版文档图片，自动进行OCR和NLP处理，自动分类。

2. **获取文档列表：**
   
   - `GET /documents` - 获取所有已上传文档。

3. **获取文档详情：**
   
   - `GET /documents/{id}` - 获取特定文档的各种信息, 包括所属分类, OCR识别结果等。

4. **删除文档：**
   
   - `DELETE /documents/{id}` - 删除特定文档。

5. **根据名称检索文档：**
   
   - `GET /documents/search/{search_name}` - 根据名称检索文档。

6. **修改文档：**
   
   - `PATCH /documents/{id}` - 手动修改特定文档的信息, 如名称, 所属的类别。

### 图片相关API

1. **根据文档ID获取图片URL：**

   - `GET /images/{document_id}` - 根据文档ID获取对应图片URL。

### 文档分类相关API

1. **获取文档分类列表：**
   
   - `GET /categories` - 获取所有文档分类。

2. **添加文档分类：**
   
   - `POST /categories` - 手动添加文档分类。

3. **修改文档分类：**
   
   - `PATCH /categories/{id}` - 手动修改特定文档分类。

4. **删除文档分类：**
   
   - `DELETE /categories/{id}` - 删除特定文档分类.

5. **检索特定文档分类下的所有文档：**
   
   - `GET /categories/{id}/documents` - 检索特定文档分类下的所有文档。

### 文档库相关API

### 文档库相关API

1. **创建文档库：**
   - `POST /libraries`
     - 输入参数：
       - `name`：文档库的名称
       - `description`：文档库的描述信息（可选）
       - `access_control`：文档库的访问控制规则，比如公开、私有或指定用户/组（可选）
     - 返回值：成功时返回新建的文档库ID和其他元数据，失败时返回错误信息。

2. **获取文档库列表：**
   - `GET /libraries`
     - 查询参数（可选）：
       - `owner_id`：文档库的所有者ID，用于过滤特定用户拥有的文档库
       - `status`：文档库的状态（启用/禁用）
     - 返回值：返回包含多个文档库基本信息的列表。

3. **获取单个文档库详情：**
   - `GET /libraries/{libraryId}`
     - 参数：
       - `{libraryId}`：文档库的唯一标识符
     - 返回值：返回指定文档库的详细信息，包括但不限于名称、描述、权限设置、创建时间、所属文档分类等。

4. **更新文档库信息：**
   - `PATCH /libraries/{libraryId}`
     - 参数：
       - `{libraryId}`：文档库的唯一标识符
     - 输入参数：
       - `name`：新的文档库名称（可选）
       - `description`：新的文档库描述（可选）
       - `access_control`：新的访问控制规则（可选）
     - 返回值：成功时返回更新后的文档库信息，失败时返回错误信息。

5. **删除文档库：**
   - `DELETE /libraries/{libraryId}`
     - 参数：
       - `{libraryId}`：要删除的文档库的唯一标识符
     - 返回值：成功时返回确认信息，失败时返回错误信息（如文档库内尚存在文档无法直接删除等）。

## 后端

### 后端数据库

#### 数据库表结构设计

1. **image表：**

  - `id` - 图片唯一标识符
  - `file_key`: sqlalchemy_utils.URLType - 存储在MinIO中的图片文件的唯一标识符
  - `document_id` - 外键关联到document表，表示该图片属于哪个文档

2. **document表：**

  - `id` - 文档唯一标识符
  - `name` - 文档名称
  - `ocr_result` - PgSQL的JSON类型，存储OCR模型提取的key-value形式的结果
  - `nlp_result` - pgvector插件的vector类型, 存储NLP模型做embedding的结果
  - `category_id` - 文档分类作为外键关联到category表

1. **category表：**

  - `id` - 分类唯一标识符
  - `name` - 分类名称
  - `description` - 分类描述
  - `library_id` - 外键关联到library表，表示该分类所属的文档库

1. **user表：**

   - `id` - 用户唯一标识符
   - `username` - 用户名
   - `email` - 用户邮箱
   - `password_hash` - 加密后的用户密码
   - `role` - 用户角色标识（如：普通用户、管理员等）

1. **user_library_association表（用户与文档库关联表，实现多对多关系）：**

   - `id` - 关联记录唯一标识符
   - `user_id` - 外键关联到user表，表示该关联记录属于哪个用户
   - `library_id` - 外键关联到library表，表示用户对该文档库的使用权
   - `permission_level` - 用户对此文档库的权限级别（如：只读、读写、管理等）

1. **library表：**

   - `id` - 文档库唯一标识符
   - `name` - 文档库名称
   - `description` - 文档库描述
   - `created_by` - 创建此文档库的用户ID（外键关联到user表）
   - `status` - 文档库状态（如：启用、禁用）
   - `access_type` - 文档库访问类型（如：公开、私有）

#### 图片存储

图片存储到MinIO数据库, 供image表查找

```markdown
**image表：**

- `file_key` - 存储在MinIO中的图片文件的唯一标识符
```

## 前端页面设计

### 页面

#### **注册登录页**

#### **上传文档页面**

  - 页面布局：提供上传文档按钮。
  - 交互设计：上传后，系统自动进行OCR、NLP和自动分类处理。上传处理过程中，页面会暂时阻塞等待后端执行算法。等后端处理完当前文档，将对应数据传回前端之后，在页面上弹出这个文档的 _文档详情 modal_ 。

#### **搜索文档页面**

  - 页面布局：顶部提供一个搜索框，用户可以输入关键词进行搜索。
  - 交互设计：搜索结果以列表形式展示，每个结果旁边有"查看详情"按钮。点击后，弹出对应的 _文档详情 modal_。

#### **文档分类管理页面**

1. 文档分类管理页面
    - 页面布局：采用卡片式布局，每个卡片展示一个文档分类。
    - 交互设计：用户点击分类卡片，页面跳转到对应的文档分类详情页面。
    - 在页面上提供"添加"操作按钮, 点击后弹出 _dialog_, 可以输入名称添加一个文档分类
    - 在每个分类卡片上提供"详情"、"查看/编辑"、"删除"操作的按钮，允许用户进行相应的改名和删除操作。

      - 详情按钮: 跳转到对应的文档分类详情页面
      - 查看/编辑按钮: 点击后弹出 _modal_, 可以查看和修改名称和描述，可以在select选择器中选择和更改所属的文档库。
      - 删除按钮: 点击后弹出 _popconfirm_, 其中包含确定和取消按钮, 如果再次点击确定按钮则执行删除

2. 子页面： **文档分类详情页面**

    - 页面布局：以卡片形式展示该分类下的所有文档。
    - 在每个文档卡片上提供"查看 / 编辑"、"删除"操作的按钮，允许用户进行相应的改名和删除操作。

      - 查看 / 编辑按钮: 点击后弹出 _文档详情 modal_
      - 删除按钮: 点击后弹出 _popconfirm_, 其中包含确定和取消按钮, 如果再次点击确定按钮则执行删除

#### **文档库管理页面**
 - 页面布局：采用卡片式布局，每个卡片展示一个文档库。
 - 在页面上提供"添加"操作按钮, 点击后弹出 _dialog_, 可以输入名称添加一个文档库
 - 在每个分类卡片上提供"查看/编辑"、"删除"操作的按钮，允许用户进行相应的查看，修改和删除操作。
   - 查看/编辑按钮: 点击后弹出 _Modal_，该窗口不仅展示文档库的完整详细信息，还允许用户在此Modal中直接编辑文档库的名称、描述以及访问权限等信息。编辑完成后，用户提交更改。
   - 删除按钮: 点击后弹出 _popconfirm_, 其中包含确定和取消按钮, 如果再次点击确定按钮则执行删除

### 组件

1. **文档详情模态对话框**

    - 对话框内容：展示文档的OCR识别结果、分类信息、图片存储URL等信息。
    - 操作选项：支持复制URL下载图片，以及关闭对话框的选项。可以在select选择器中选择和更改所属的分类。提交 _modal_ 时根据其中的信息修改文档对应的信息。

      - 提交按钮: 根据 _modal_ 中的信息修改文档对应的信息
      - 取消按钮: 退出 _modal_

2. **导航栏**

    - 设计：导航栏固定在页面的左侧，垂直布局。
    - 内容：包含以下按钮：

      - 首页：跳转到首页。
      - 上传文档：跳转到上传文档页面。
      - 搜索文档：跳转到搜索文档页面。
      - 文档分类管理：跳转到文档分类管理页面。

    - 通过配置`frontend/.umirc.ts`中的`routes`参数来实现
